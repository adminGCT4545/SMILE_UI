<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KYNSEY AI - Green Chip Technology</title>
    <script src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/prop-types@15.7.2/prop-types.min.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <style>
        /* Modern Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            height: 100vh;
            display: flex;
            background-color: #121212;
            color: #ffffff;
        }

        /* Header - Modern Dark Style */
        .header {
            background-color: #202124;
            padding: 1rem 1.5rem;
            box-shadow: 0 1px 0 rgba(255, 255, 255, 0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
        }

        .hamburger-menu {
            cursor: pointer;
            padding-right: 1rem;
        }

        .hamburger-menu::before {
            content: "â˜°";
            font-size: 1.5rem;
        }

        .app-title {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .app-subtitle {
            font-size: 0.8rem;
            color: #9aa0a6;
        }

        /* Sidebar - Dark and Minimal */
        .sidebar {
            width: 60px;
            background-color: #202124;
            padding: 1rem 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 1px 0 0 rgba(255, 255, 255, 0.08);
        }

        .sidebar-button {
            background: transparent;
            border: none;
            color: #ffffff;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.8;
            transition: opacity 0.2s ease;
        }

        .sidebar-button:hover {
            opacity: 1;
            background-color: rgba(255, 255, 255, 0.1);
        }

        .sidebar-button i, .sidebar-button span {
            font-size: 1.2rem;
        }

        /* Main Content Area - Dark Theme Chat */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-container {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            max-width: 1000px;
            margin: 0 auto;
            width: 100%;
            display: flex;
            flex-direction: column;
        }

        .message {
            margin-bottom: 1rem;
            padding: 0.8rem 1.2rem;
            border-radius: 1rem;
            max-width: 80%;
            clear: both;
            word-wrap: break-word; /* Ensure long words break */
            white-space: pre-wrap; /* Preserve whitespace and wrap */
        }

        .user-message {
            background-color: #0b84ff;
            color: white;
            margin-left: auto;
            text-align: left; /* Align text left even in right-aligned bubble */
            align-self: flex-end; /* Align bubble to the right */
        }

        .assistant-message {
            background-color: #292a2d;
            color: #e8e8e8;
            align-self: flex-start;
        }

        .assistant-message img, .user-message img {
            max-width: 100%;
            border-radius: 0.5rem;
            margin-top: 0.5rem;
            display: block; /* Ensure image takes block space */
        }

        /* Smart suggestions */
        .smart-suggestions {
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.85rem;
            color: #9aa0a6;
        }
        
        .suggestion-item {
            display: inline-block;
            background-color: #3c4043;
            padding: 0.2rem 0.6rem;
            border-radius: 1rem;
            margin-right: 0.5rem;
            margin-top: 0.3rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .suggestion-item:hover {
            background-color: #5f6368;
        }

        /* Code block styling */
        .code-block {
            background-color: #1e1e1e;
            border: 1px solid #3d3d3e;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 0.75rem;
            overflow-x: auto;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9rem;
            white-space: pre;
        }

        /* Search results styling */
        .search-results {
            background-color: #1e1e1e;
            border: 1px solid #3d3d3e;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 0.75rem;
            width: 100%;
        }
        
        .search-result-item {
            margin-bottom: 0.75rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #3d3d3e;
        }
        
        .search-result-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        
        .search-result-title {
            font-weight: bold;
            color: #0b84ff;
            margin-bottom: 0.25rem;
        }
        
        .search-result-url {
            font-size: 0.8rem;
            color: #9aa0a6;
            margin-bottom: 0.25rem;
            word-break: break-all;
        }
        
        .search-result-snippet {
            font-size: 0.9rem;
        }

        /* Typing indicator */
        .typing-indicator {
            font-style: italic;
            color: #9aa0a6;
        }

        /* Voice input indicator */
        .voice-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #0b84ff;
            font-size: 0.9rem;
        }
        
        .voice-indicator-dot {
            width: 8px;
            height: 8px;
            background-color: #0b84ff;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(0.8); opacity: 0.5; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(0.8); opacity: 0.5; }
        }

        /* Settings Panel */
        .settings-panel {
            position: fixed;
            top: 0;
            right: -300px;
            width: 300px;
            height: 100vh;
            background-color: #202124;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.5);
            transition: right 0.3s ease;
            z-index: 1000;
            padding: 1.5rem;
            color: #ffffff; /* Ensure text is visible */
            overflow-y: auto; /* Make scrollable */
        }

        .settings-panel.active {
            right: 0;
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .settings-title {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .close-settings {
            background: none;
            border: none;
            color: #ffffff;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .settings-section {
            margin-bottom: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 1rem;
        }

        .settings-section:last-child {
            border-bottom: none;
        }

        .settings-section-title {
            font-size: 0.9rem;
            color: #9aa0a6;
            margin-bottom: 0.5rem;
            text-transform: uppercase; /* Style consistency */
        }

        .settings-option {
            display: flex;
            align-items: center;
            padding: 0.5rem 0;
            cursor: pointer;
        }
         .settings-option label {
            margin-left: 0.5rem; /* Spacing between radio and label */
            cursor: pointer;
        }

        .settings-option input[type="radio"],
        .settings-option input[type="checkbox"] {
            cursor: pointer;
            accent-color: #0b84ff;
        }

        #activeModelDisplay {
            padding: 0.5rem;
            background-color: #3d3d3e;
            border-radius: 0.25rem;
            font-size: 0.9rem;
        }

        /* Image Upload Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            z-index: 1001;
        }

        .modal.active {
            display: flex; /* Show when active */
        }

        .modal-content {
            background-color: #202124;
            padding: 2rem;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 500px;
            color: #ffffff; /* Ensure text is visible */
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .close-modal {
            background: none;
            border: none;
            color: #ffffff;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .file-upload-area {
            border: 2px dashed #3d3d3e;
            border-radius: 0.5rem;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            margin-bottom: 1rem;
            transition: border-color 0.2s ease; /* Smooth transition */
        }

        .file-upload-area:hover {
            border-color: #0b84ff;
        }

        .file-upload-text {
            color: #9aa0a6;
            margin-bottom: 1rem;
        }

        .file-preview {
            max-width: 100%;
            max-height: 200px;
            margin: 1rem auto; /* Center preview */
            display: none; /* Hidden until image selected */
            border-radius: 0.25rem; /* Slight rounding */
        }

        .file-info {
            color: #e8e8e8;
            margin: 1rem 0;
            display: none;
            word-break: break-all;
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            margin-top: 1rem; /* Add space above buttons */
        }

        .modal-button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.9rem;
            border: none;
            font-weight: 500; /* Slightly bolder text */
            transition: background-color 0.2s ease; /* Smooth transition */
        }

        .modal-button.primary {
            background-color: #0b84ff;
            color: white;
        }
        .modal-button.primary:hover {
            background-color: #005ec4;
        }
        .modal-button.primary:disabled {
            background-color: #3d3d3e;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .modal-button.secondary {
            background-color: #3d3d3e;
            color: white;
        }
         .modal-button.secondary:hover {
            background-color: #5f6368;
        }

        /* Input Container - Dark Style */
        .input-container {
            background-color: #202124;
            padding: 1rem 1.5rem;
            box-shadow: 0 -1px 0 rgba(255, 255, 255, 0.08);
        }

        .input-form {
            max-width: 1000px;
            margin: 0 auto;
            display: flex;
            gap: 0.75rem;
            align-items: flex-end; /* Align items to bottom for multi-line textarea */
        }

        .input-actions {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            padding-bottom: 0.5rem;
        }

        .input-action-button {
            background: transparent;
            border: none;
            color: #9aa0a6;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0.25rem;
            transition: color 0.2s ease;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .input-action-button:hover {
            color: #ffffff;
            background-color: rgba(255, 255, 255, 0.1);
        }

        .input-action-button.active {
            color: #0b84ff;
        }

        .message-input-wrapper {
            flex: 1;
            position: relative;
            background-color: #121212;
            border: 1px solid #3d3d3e;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            padding: 0 0.5rem;
        }

        .message-input-wrapper:focus-within {
            border-color: #0b84ff;
            box-shadow: 0 0 0 1px #0b84ff;
        }

        .message-input {
            flex: 1;
            padding: 0.75rem 0.5rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            resize: none;
            background-color: transparent;
            color: #ffffff;
            max-height: 150px; /* Limit max height */
            overflow-y: auto; /* Add scroll if needed */
            line-height: 1.4; /* Improve readability */
        }

        .message-input:focus {
            outline: none;
        }

        .send-button {
            padding: 0.75rem 1.5rem;
            background-color: #0b84ff;
            color: white;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.2s ease;
            height: calc(1.5rem + 2 * 0.75rem); /* Match initial textarea height */
            align-self: flex-end; /* Keep button aligned to bottom */
        }

        .send-button:hover {
            background-color: #005ec4;
        }
        .send-button:disabled {
             background-color: #3d3d3e;
             cursor: not-allowed;
             opacity: 0.7;
        }

        /* File input hidden */
        #imageFileInput, #documentFileInput {
            display: none;
        }

        /* Dark mode tooltip */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltip-text {
            visibility: hidden;
            width: 120px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -60px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.8rem;
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <button class="sidebar-button" id="newChat" title="New Chat"><span>+</span></button>
        <button class="sidebar-button" id="documentsBtn" title="Upload Document"><span>&#128196;</span></button>
        <button class="sidebar-button" id="imagesBtn" title="Upload Image"><span>&#128249;</span></button>
        <button class="sidebar-button" id="settingsBtn" title="Settings"><span>&#9881;</span></button>
        <button class="sidebar-button" id="erpDashboardBtn" title="ERP Dashboard" onclick="window.location.href='/erp-dashboard'"><span>ðŸ“Š</span></button>
    </div>

    <div class="main-content">
        <header class="header">
            <div class="header-left">
                <div class="app-info">
                    <h1 class="app-title">KYNSEY AI</h1>
                    <p class="app-subtitle">Green Chip Technology</p>
                </div>
            </div>
            <div>
                <!-- Additional header elements can go here -->
            </div>
        </header>

        <main class="chat-container" id="chatContainer">
            <!-- Initial welcome message will be added by JS -->
        </main>

        <div class="input-container">
            <form class="input-form" id="chatForm">
                <div class="input-actions">
                    <button type="button" class="input-action-button tooltip" id="attachImageBtn" title="Attach Image">
                        &#128247;
                        <span class="tooltip-text">Upload Image</span>
                    </button>
                    <button type="button" class="input-action-button tooltip" id="attachDocBtn" title="Attach Document">
                        &#128196;
                        <span class="tooltip-text">Upload Document</span>
                    </button>
                    <button type="button" class="input-action-button tooltip" id="voiceInputBtn" title="Voice Input">
                        &#127908;
                        <span class="tooltip-text">Voice Input</span>
                    </button>
                </div>
                <div class="message-input-wrapper">
                    <textarea
                        class="message-input"
                        id="messageInput"
                        placeholder="Type your message or use commands: /search, /email..."
                        rows="1"
                    ></textarea>
                </div>
                <button type="submit" class="send-button" id="sendButton">Send</button>
            </form>
        </div>
    </div>

    <!-- Settings Panel -->
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-header">
            <h2 class="settings-title">Settings</h2>
            <button class="close-settings" id="closeSettings">&times;</button>
        </div>
        <div class="settings-section">
            <h3 class="settings-section-title">RESPONSE STYLE</h3>
            <div class="settings-option">
                <input type="radio" id="professionalStyle" name="responseStyle" value="professional">
                <label for="professionalStyle">Professional</label>
            </div>
            <div class="settings-option">
                <input type="radio" id="conciseStyle" name="responseStyle" value="concise">
                <label for="conciseStyle">Concise</label>
            </div>
            <div class="settings-option">
                <input type="radio" id="normalStyle" name="responseStyle" value="normal" checked>
                <label for="normalStyle">Normal</label>
            </div>
            <div class="settings-option">
                <input type="radio" id="creativeStyle" name="responseStyle" value="creative">
                <label for="creativeStyle">Creative</label>
            </div>
        </div>
        <div class="settings-section">
            <h3 class="settings-section-title">FEATURES</h3>
            <div class="settings-option">
                <input type="checkbox" id="enableSuggestions" name="enableSuggestions" checked>
                <label for="enableSuggestions">Show Smart Suggestions</label>
            </div>
            <div class="settings-option">
                <input type="checkbox" id="enableWebSearch" name="enableWebSearch" checked>
                <label for="enableWebSearch">Enable Web Search</label>
            </div>
            <div class="settings-option">
                <input type="checkbox" id="enableVoiceInput" name="enableVoiceInput" checked>
                <label for="enableVoiceInput">Enable Voice Input</label>
            </div>
        </div>
        <div class="settings-section">
            <h3 class="settings-section-title">ACTIVE MODEL</h3>
            <div id="activeModelDisplay">llama3.2:3b-instruct-fp16</div>
        </div>
        <div class="settings-section">
            <h3 class="settings-section-title">CONVERSATION HISTORY</h3>
            <button id="clearHistory" style="padding: 0.5rem 1rem; background-color: #dc3545; color: white; border: none; border-radius: 0.25rem; cursor: pointer; width: 100%;">
                Clear Conversation History
            </button>
        </div>
         <div class="settings-section">
            <h3 class="settings-section-title">ADMIN</h3>
             <button id="goToAdmin" style="padding: 0.5rem 1rem; background-color: #3d3d3e; color: white; border: none; border-radius: 0.25rem; cursor: pointer; width: 100%;" onclick="window.location.href='admin_panel.html'">
                Go to Admin Panel
            </button>
        </div>
    </div>

    <!-- Image Upload Modal -->
    <div class="modal" id="imageUploadModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Upload Image</h2>
                <button class="close-modal" id="closeImageModal">&times;</button>
            </div>
            <div class="file-upload-area" id="imageDropArea">
                <p class="file-upload-text">Drag & drop an image or click to browse</p>
                <input type="file" id="imageFileInput" accept="image/jpeg, image/png, image/gif, image/webp">
                <img src="" alt="Preview" class="file-preview" id="imagePreview">
            </div>
            <div class="modal-buttons">
                <button class="modal-button secondary" id="cancelImageUpload">Cancel</button>
                <button class="modal-button primary" id="confirmImageUpload" disabled>Upload</button>
            </div>
        </div>
    </div>

    <!-- Document Upload Modal -->
    <div class="modal" id="documentUploadModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Upload Document</h2>
                <button class="close-modal" id="closeDocumentModal">&times;</button>
            </div>
            <div class="file-upload-area" id="documentDropArea">
                <p class="file-upload-text">Drag & drop a document (PDF, DOCX, CSV, TXT) or click to browse</p>
                <input type="file" id="documentFileInput" accept=".pdf,.doc,.docx,.txt,.csv,.xls,.xlsx">
                <div class="file-info" id="documentInfo">
                    <p>Selected file: <strong id="documentFilename"></strong></p>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-button secondary" id="cancelDocumentUpload">Cancel</button>
                <button class="modal-button primary" id="confirmDocumentUpload" disabled>Upload</button>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const chatForm = document.getElementById('chatForm');
        const messageInput = document.getElementById('messageInput');
        const chatContainer = document.getElementById('chatContainer');
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsPanel = document.getElementById('settingsPanel');
        const closeSettings = document.getElementById('closeSettings');
        const imagesBtn = document.getElementById('imagesBtn');
        const documentsBtn = document.getElementById('documentsBtn');
        const imageUploadModal = document.getElementById('imageUploadModal');
        const documentUploadModal = document.getElementById('documentUploadModal');
        const closeImageModal = document.getElementById('closeImageModal');
        const closeDocumentModal = document.getElementById('closeDocumentModal');
        const imageDropArea = document.getElementById('imageDropArea');
        const documentDropArea = document.getElementById('documentDropArea');
        const imageFileInput = document.getElementById('imageFileInput');
        const documentFileInput = document.getElementById('documentFileInput');
        const imagePreview = document.getElementById('imagePreview');
        const documentInfo = document.getElementById('documentInfo');
        const documentFilename = document.getElementById('documentFilename');
        const confirmImageUpload = document.getElementById('confirmImageUpload');
        const confirmDocumentUpload = document.getElementById('confirmDocumentUpload');
        const cancelImageUpload = document.getElementById('cancelImageUpload');
        const cancelDocumentUpload = document.getElementById('cancelDocumentUpload');
        const clearHistory = document.getElementById('clearHistory');
        const newChat = document.getElementById('newChat');
        const responseStyleOptions = document.querySelectorAll('input[name="responseStyle"]');
        const sendButton = document.getElementById('sendButton');
        const activeModelDisplay = document.getElementById('activeModelDisplay');
        const attachImageBtn = document.getElementById('attachImageBtn');
        const attachDocBtn = document.getElementById('attachDocBtn');
        const voiceInputBtn = document.getElementById('voiceInputBtn');
        const enableSuggestions = document.getElementById('enableSuggestions');
        const enableWebSearch = document.getElementById('enableWebSearch');
        const enableVoiceInput = document.getElementById('enableVoiceInput');

        // Global variables
        let selectedImageData = null; // Store base64 data
        let selectedDocumentData = null; // Store document data
        let conversationHistory = [];
        let currentResponseStyle = 'normal';
        let isWaitingForResponse = false; // Prevent multiple submissions
        let isRecording = false; // For voice input

        // API endpoint
        const API_ENDPOINT = 'http://localhost:3002/api/chat';

        // --- Initialization ---
        function initializeChat() {
            // Load history from local storage if available
            const savedHistory = localStorage.getItem('kynseyConversationHistory');
            if (savedHistory) {
                conversationHistory = JSON.parse(savedHistory);
                renderHistory();
            } else {
                // Add initial welcome message if no history
                addMessage('Hello! How can I help you today? Try asking me to search for something using the /search command, or draft an email with /email.', 'assistant-message', false, 
                [
                    'Search the web for AI news',
                    'Draft an email to my team',
                    'How to upload documents?'
                ]); 
            }

            // Load response style
            const savedStyle = localStorage.getItem('kynseyResponseStyle');
            if (savedStyle) {
                currentResponseStyle = savedStyle;
                document.querySelector(`input[name="responseStyle"][value="${currentResponseStyle}"]`).checked = true;
            }

            // Load feature settings
            if (localStorage.getItem('kynseyEnableSuggestions') === 'false') {
                enableSuggestions.checked = false;
            }
            if (localStorage.getItem('kynseyEnableWebSearch') === 'false') {
                enableWebSearch.checked = false;
            }
            if (localStorage.getItem('kynseyEnableVoiceInput') === 'false') {
                enableVoiceInput.checked = false;
            }

            activeModelDisplay.textContent = 'llama3.2:3b-instruct-fp16';
        }

        function saveState() {
            localStorage.setItem('kynseyConversationHistory', JSON.stringify(conversationHistory));
            localStorage.setItem('kynseyResponseStyle', currentResponseStyle);
            localStorage.setItem('kynseyEnableSuggestions', enableSuggestions.checked);
            localStorage.setItem('kynseyEnableWebSearch', enableWebSearch.checked);
            localStorage.setItem('kynseyEnableVoiceInput', enableVoiceInput.checked);
        }

        function renderHistory() {
            chatContainer.innerHTML = ''; // Clear existing messages
            conversationHistory.forEach(msg => {
                if (msg.role === 'user') {
                    addMessage(msg.content, 'user-message', false);
                } else {
                    addMessage(msg.content, 'assistant-message', false, msg.suggestions || []);
                }
            });
        }

        // --- UI Updates ---

        // Auto-resize textarea
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            const scrollHeight = this.scrollHeight;
            this.style.height = scrollHeight + 'px';

            // Adjust max height if needed
            const maxHeight = window.innerHeight * 0.3;
            if (scrollHeight > maxHeight) {
                this.style.height = maxHeight + 'px';
                this.style.overflowY = 'auto';
            } else {
                this.style.overflowY = 'hidden';
            }

            // Enable/disable send button based on content
            sendButton.disabled = this.value.trim().length === 0;
        });

        // Function to add message to UI
        function addMessage(text, className, save = true, suggestions = []) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', className);

            // Check if text is a string or object
            if (typeof text === 'object' && text !== null) {
                // Handle different message types
                if (text.type === 'image' && text.base64) {
                    const textElem = document.createElement('p');
                    textElem.textContent = text.message || 'Image:';
                    messageDiv.appendChild(textElem);
                    
                    const img = document.createElement('img');
                    img.src = `data:image/jpeg;base64,${text.base64}`;
                    img.alt = 'Uploaded image';
                    messageDiv.appendChild(img);
                } else if (text.type === 'document' && text.filename) {
                    const textElem = document.createElement('p');
                    textElem.textContent = text.message || `Document: ${text.filename}`;
                    messageDiv.appendChild(textElem);
                    
                    const docInfo = document.createElement('p');
                    docInfo.innerHTML = `<i>ðŸ“„ ${text.filename}</i>`;
                    docInfo.style.fontSize = '0.85rem';
                    docInfo.style.marginTop = '0.5rem';
                    messageDiv.appendChild(docInfo);
                } else if (text.type === 'search' && text.results) {
                    const textElem = document.createElement('p');
                    textElem.textContent = text.message || 'Search results:';
                    messageDiv.appendChild(textElem);
                    
                    const resultsDiv = document.createElement('div');
                    resultsDiv.classList.add('search-results');
                    
                    text.results.forEach(result => {
                        const resultItem = document.createElement('div');
                        resultItem.classList.add('search-result-item');
                        
                        const title = document.createElement('div');
                        title.classList.add('search-result-title');
                        title.textContent = result.title;
                        
                        const url = document.createElement('div');
                        url.classList.add('search-result-url');
                        url.textContent = result.url;
                        
                        const snippet = document.createElement('div');
                        snippet.classList.add('search-result-snippet');
                        snippet.textContent = result.snippet;
                        
                        resultItem.appendChild(title);
                        resultItem.appendChild(url);
                        resultItem.appendChild(snippet);
                        resultsDiv.appendChild(resultItem);
                    });
                    
                    messageDiv.appendChild(resultsDiv);
                } else if (text.type === 'email') {
                    const textElem = document.createElement('p');
                    textElem.textContent = text.message || 'Email draft:';
                    messageDiv.appendChild(textElem);
                    
                    const emailDiv = document.createElement('div');
                    emailDiv.style.border = '1px solid #3d3d3e';
                    emailDiv.style.borderRadius = '0.5rem';
                    emailDiv.style.padding = '1rem';
                    emailDiv.style.marginTop = '0.75rem';
                    
                    const subject = document.createElement('div');
                    subject.style.fontWeight = 'bold';
                    subject.style.marginBottom = '0.5rem';
                    subject.textContent = `Subject: ${text.subject}`;
                    
                    const to = document.createElement('div');
                    to.style.marginBottom = '0.5rem';
                    to.textContent = `To: ${text.to}`;
                    
                    const body = document.createElement('div');
                    body.style.borderTop = '1px solid #3d3d3e';
                    body.style.paddingTop = '0.5rem';
                    body.style.whiteSpace = 'pre-wrap';
                    body.textContent = text.body;
                    
                    emailDiv.appendChild(subject);
                    emailDiv.appendChild(to);
                    emailDiv.appendChild(body);
                    messageDiv.appendChild(emailDiv);
                } else if (text.type === 'code') {
                    const textElem = document.createElement('p');
                    textElem.textContent = text.message || 'Generated code:';
                    messageDiv.appendChild(textElem);
                    
                    const codeBlock = document.createElement('pre');
                    codeBlock.classList.add('code-block');
                    codeBlock.textContent = text.code;
                    messageDiv.appendChild(codeBlock);
                } else {
                    // Default to text message
                    messageDiv.textContent = text.message || JSON.stringify(text);
                }
            } else {
                // Handle basic Markdown-like formatting for images (if backend sends them)
                if (className === 'assistant-message' && text.includes('![')) {
                    const imgRegex = /!\[.*?\]\((.*?)\)/g;
                    let lastIndex = 0;
                    let match;

                    while ((match = imgRegex.exec(text)) !== null) {
                        // Add text before the image
                        if (match.index > lastIndex) {
                            const textNode = document.createTextNode(text.substring(lastIndex, match.index));
                            messageDiv.appendChild(textNode);
                        }
                        // Add the image
                        const img = document.createElement('img');
                        img.src = match[1];
                        img.alt = 'Response image';
                        messageDiv.appendChild(img);
                        lastIndex = imgRegex.lastIndex;
                    }
                    // Add any remaining text after the last image
                    if (lastIndex < text.length) {
                        const textNode = document.createTextNode(text.substring(lastIndex));
                        messageDiv.appendChild(textNode);
                    }
                } else {
                    // For regular text messages
                    messageDiv.textContent = text;
                }
            }

            // Add suggestions if provided and this is an assistant message
            if (className === 'assistant-message' && suggestions.length > 0 && enableSuggestions.checked) {
                const suggestionsDiv = document.createElement('div');
                suggestionsDiv.classList.add('smart-suggestions');
                
                const suggestionsLabel = document.createElement('span');
                suggestionsLabel.textContent = 'Suggestions: ';
                suggestionsDiv.appendChild(suggestionsLabel);
                
                suggestions.forEach(suggestion => {
                    const suggestionItem = document.createElement('span');
                    suggestionItem.classList.add('suggestion-item');
                    suggestionItem.textContent = suggestion;
                    suggestionItem.dataset.suggestion = suggestion;
                    suggestionsDiv.appendChild(suggestionItem);
                });
                
                messageDiv.appendChild(suggestionsDiv);
            }

            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight; // Scroll to bottom

            // Save to history and local storage if required
            if (save) {
                const role = className === 'user-message' ? 'user' : 'assistant';
                const messageObj = { 
                    role: role, 
                    content: text,
                    suggestions: role === 'assistant' ? suggestions : []
                };
                conversationHistory.push(messageObj);
                saveState();
            }
        }

        // Function to show typing indicator
        function showTypingIndicator() {
            removeTypingIndicator(); // Remove any previous indicator
            const typingDiv = document.createElement('div');
            typingDiv.classList.add('message', 'assistant-message', 'typing-indicator');
            typingDiv.textContent = 'Thinking...';
            chatContainer.appendChild(typingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            isWaitingForResponse = true;
            sendButton.disabled = true; // Disable send button
            messageInput.disabled = true; // Disable input field
        }

        // Function to remove typing indicator
        function removeTypingIndicator() {
            const typingIndicator = chatContainer.querySelector('.typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
             isWaitingForResponse = false;
             sendButton.disabled = false; // Re-enable send button
             messageInput.disabled = false; // Re-enable input field
             messageInput.focus(); // Focus back on input
        }

        // --- Command Handling ---
        
        function processCommand(message) {
            const trimmedMessage = message.trim();
            
            if (trimmedMessage.startsWith('/search ') && enableWebSearch.checked) {
                const query = trimmedMessage.substring(8).trim();
                return handleSearchCommand(query);
            } else if (trimmedMessage.startsWith('/email ')) {
                const emailParams = trimmedMessage.substring(7).trim();
                return handleEmailCommand(emailParams);
            } else {
                return false; // Not a recognized command
            }
        }
        
        async function handleSearchCommand(query) {
            if (!query) return false;
            
            addMessage(`Searching the web for: "${query}"`, 'user-message');
            showTypingIndicator();
            
            // Simulate search results (would use a real search API in production)
            setTimeout(() => {
                removeTypingIndicator();
                
                const searchResponse = {
                    type: 'search',
                    message: `Here are some results for "${query}":`,
                    results: [
                        {
                            title: 'Sample Search Result 1',
                            url: 'https://example.com/result1',
                            snippet: 'This is a summary of the first search result that would match your query.'
                        },
                        {
                            title: 'Sample Search Result 2',
                            url: 'https://example.com/result2',
                            snippet: 'Here is another search result with relevant information about your search.'
                        },
                        {
                            title: 'Sample Search Result 3',
                            url: 'https://example.com/result3',
                            snippet: 'A third search result providing additional context and information.'
                        }
                    ]
                };
                
                addMessage(searchResponse, 'assistant-message', true, [
                    `Tell me more about ${query}`,
                    `Summarize these results`,
                    `Refine search: ${query} latest news`
                ]);
            }, 1500);
            
            return true;
        }
        
        function handleEmailCommand(params) {
            // Simple parsing - in a real app, use more sophisticated parsing
            let to = 'recipient@example.com';
            let subject = 'Meeting Follow-up';
            let content = '';
            
            // Extract params if provided
            if (params.includes('to:')) {
                const toMatch = params.match(/to:\s*([^\s,;]+)/);
                if (toMatch && toMatch[1]) to = toMatch[1];
            }
            
            if (params.includes('subject:')) {
                const subjectMatch = params.match(/subject:\s*([^,;]+)(,|;|$)/);
                if (subjectMatch && subjectMatch[1]) subject = subjectMatch[1].trim();
            }
            
            // Any remaining text is treated as content directive
            content = params
                .replace(/to:\s*([^\s,;]+)(,|;|$)/, '')
                .replace(/subject:\s*([^,;]+)(,|;|$)/, '')
                .trim();
                
            if (!content) {
                content = 'Draft a professional email';
            }
            
            addMessage(`Draft an email to: ${to} with subject: "${subject}" about: ${content}`, 'user-message');
            showTypingIndicator();
            
            setTimeout(() => {
                removeTypingIndicator();
                
                const emailResponse = {
                    type: 'email',
                    message: 'Here is your email draft:',
                    to: to,
                    subject: subject,
                    body: `Dear Recipient,

I hope this email finds you well. As requested, I wanted to follow up on our recent discussion about the project timeline.

The team has made significant progress, and we're on track to meet our deadlines. I've attached the latest progress report for your review.

Please let me know if you need any clarification or have additional questions.

Best regards,
[Your Name]`
                };
                
                addMessage(emailResponse, 'assistant-message', true, [
                    'Make it more formal',
                    'Make it more casual',
                    'Add section about budget'
                ]);
            }, 1500);
            
            return true;
        }

        // --- Event Handlers ---

        // Handle chat form submission
        chatForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            if (isWaitingForResponse) return; // Prevent submission while waiting

            const message = messageInput.value.trim();

            if (message) {
                // Check if message is a command
                const isCommand = processCommand(message);
                
                if (!isCommand) {
                    // Regular message - add to UI and send to backend
                    addMessage(message, 'user-message');

                    // Clear input and reset height
                    messageInput.value = '';
                    messageInput.style.height = 'auto';
                    messageInput.dispatchEvent(new Event('input')); // Trigger resize logic

                    // Prepare data for API
                    const requestData = {
                        message: message,
                        history: conversationHistory.slice(-10), // Send recent history
                        responseStyle: currentResponseStyle,
                        image: selectedImageData
                    };

                    // Clear selected image data after preparing request
                    selectedImageData = null;

                    try {
                        showTypingIndicator();
                        const response = await sendMessageToLLM(requestData);
                        removeTypingIndicator();
                        
                        // Generate relevant suggestions based on context
                        let suggestions = [];
                        
                        if (message.toLowerCase().includes('search') || message.toLowerCase().includes('find')) {
                            suggestions = ['Use /search to search the web', 'Tell me more about this', 'How does this work?'];
                        } else if (message.toLowerCase().includes('email') || message.toLowerCase().includes('draft')) {
                            suggestions = ['Use /email to draft an email', 'Make it more formal', 'Add more details'];
                        } else if (message.toLowerCase().includes('help') || message.toLowerCase().includes('what can you do')) {
                            suggestions = ['Search the web', 'Draft an email', 'Upload a document'];
                        } else {
                            suggestions = ['Tell me more', 'Give an example', 'Search for related info'];
                        }
                        
                        addMessage(response, 'assistant-message', true, suggestions);
                    } catch (error) {
                        console.error('Error:', error);
                        removeTypingIndicator();
                        addMessage(`Sorry, there was an error: ${error.message}. Please check the backend connection and try again.`, 'assistant-message');
                    }
                }
            }
        });

        // Allow sending with Enter (not Shift+Enter)
        messageInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); // Prevent newline
                chatForm.requestSubmit(); // Trigger form submission
            }
        });

        // Settings panel handlers
        settingsBtn.addEventListener('click', () => settingsPanel.classList.add('active'));
        closeSettings.addEventListener('click', () => settingsPanel.classList.remove('active'));

        // Image upload modal handlers
        imagesBtn.addEventListener('click', () => openImageModal());
        attachImageBtn.addEventListener('click', () => openImageModal());
        closeImageModal.addEventListener('click', () => closeModal('image'));
        cancelImageUpload.addEventListener('click', () => closeModal('image'));

        // Document upload modal handlers
        documentsBtn.addEventListener('click', () => openDocumentModal());
        attachDocBtn.addEventListener('click', () => openDocumentModal());
        closeDocumentModal.addEventListener('click', () => closeModal('document'));
        cancelDocumentUpload.addEventListener('click', () => closeModal('document'));

        // Modal functions
        function openImageModal() {
            resetImageUpload();
            imageUploadModal.classList.add('active');
        }
        
        function openDocumentModal() {
            resetDocumentUpload();
            documentUploadModal.classList.add('active');
        }
        
        function closeModal(type) {
            if (type === 'image') {
                imageUploadModal.classList.remove('active');
                resetImageUpload();
            } else if (type === 'document') {
                documentUploadModal.classList.remove('active');
                resetDocumentUpload();
            }
        }

        // Handle file selection for images
        imageDropArea.addEventListener('click', () => imageFileInput.click());
        imageFileInput.addEventListener('change', (e) => handleImageFiles(e.target.files));
        
        // Handle drag and drop for images
        imageDropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            imageDropArea.style.borderColor = '#0b84ff';
        });
        imageDropArea.addEventListener('dragleave', () => {
            imageDropArea.style.borderColor = '#3d3d3e';
        });
        imageDropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            imageDropArea.style.borderColor = '#3d3d3e';
            handleImageFiles(e.dataTransfer.files);
        });

        // Handle file selection for documents
        documentDropArea.addEventListener('click', () => documentFileInput.click());
        documentFileInput.addEventListener('change', (e) => handleDocumentFiles(e.target.files));
        
        // Handle drag and drop for documents
        documentDropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            documentDropArea.style.borderColor = '#0b84ff';
        });
        documentDropArea.addEventListener('dragleave', () => {
            documentDropArea.style.borderColor = '#3d3d3e';
        });
        documentDropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            documentDropArea.style.borderColor = '#3d3d3e';
            handleDocumentFiles(e.dataTransfer.files);
        });

        // Handle the selected image files
        function handleImageFiles(files) {
            if (files.length > 0) {
                const file = files[0];
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        imagePreview.src = e.target.result;
                        imagePreview.style.display = 'block';
                        // Store only the base64 part
                        selectedImageData = e.target.result.split(',')[1];
                        confirmImageUpload.disabled = false;
                    };
                    reader.onerror = function(error) {
                        console.error("FileReader error: ", error);
                        alert("Error reading file.");
                        resetImageUpload();
                    };
                    reader.readAsDataURL(file);
                } else {
                    alert("Please select a valid image file (JPEG, PNG, GIF, WebP).");
                    resetImageUpload();
                }
            }
        }

        // Handle the selected document files
        function handleDocumentFiles(files) {
            if (files.length > 0) {
                const file = files[0];
                const validTypes = [
                    'application/pdf', 
                    'application/msword',
                    'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                    'text/plain',
                    'text/csv',
                    'application/vnd.ms-excel',
                    'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                ];
                
                if (validTypes.includes(file.type) || file.name.match(/\.(pdf|doc|docx|txt|csv|xls|xlsx)$/i)) {
                    selectedDocumentData = file;
                    documentFilename.textContent = file.name;
                    documentInfo.style.display = 'block';
                    confirmDocumentUpload.disabled = false;
                } else {
                    alert("Please select a valid document (PDF, DOCX, CSV, TXT, XLS, XLSX).");
                    resetDocumentUpload();
                }
            }
        }

        // Confirm image upload
        confirmImageUpload.addEventListener('click', () => {
            if (selectedImageData) {
                // Add image message to chat
                const imageMessage = {
                    type: 'image',
                    message: 'I uploaded this image:',
                    base64: selectedImageData
                };
                
                addMessage(imageMessage, 'user-message');
                
                // Simulate response (in a real app, send to backend)
                showTypingIndicator();
                setTimeout(() => {
                    removeTypingIndicator();
                    addMessage("I see the image you've uploaded. What would you like me to do with it? I can describe its contents, analyze it, or answer questions about it.", 'assistant-message', true, [
                        "Describe this image",
                        "What's in this image?",
                        "Extract text from this image"
                    ]);
                }, 1500);
                
                closeModal('image');
            }
        });

        // Confirm document upload
        confirmDocumentUpload.addEventListener('click', () => {
            if (selectedDocumentData) {
                // Add document message to chat
                const documentMessage = {
                    type: 'document',
                    message: `I've uploaded a document: ${selectedDocumentData.name}`,
                    filename: selectedDocumentData.name
                };
                
                addMessage(documentMessage, 'user-message');
                
                // Simulate response (in a real app, send to backend)
                showTypingIndicator();
                setTimeout(() => {
                    removeTypingIndicator();
                    addMessage(`I've received your document "${selectedDocumentData.name}". What would you like me to do with it? I can summarize it, extract key information, or answer specific questions about its contents.`, 'assistant-message', true, [
                        "Summarize this document",
                        "Extract key points",
                        "Find specific information"
                    ]);
                }, 1500);
                
                closeModal('document');
            }
        });

        // Reset image upload state
        function resetImageUpload() {
            imageFileInput.value = '';
            imagePreview.src = '';
            imagePreview.style.display = 'none';
            selectedImageData = null;
            confirmImageUpload.disabled = true;
        }

        // Reset document upload state
        function resetDocumentUpload() {
            documentFileInput.value = '';
            documentInfo.style.display = 'none';
            documentFilename.textContent = '';
            selectedDocumentData = null;
            confirmDocumentUpload.disabled = true;
        }

        // Clear conversation history
        clearHistory.addEventListener('click', () => {
            if (confirm('Are you sure you want to clear the conversation history? This cannot be undone.')) {
                conversationHistory = [];
                chatContainer.innerHTML = '';
                addMessage('Hello! How can I help you today? Try asking me to search for something using the /search command, or draft an email with /email.', 'assistant-message', false, 
                [
                    'Search the web for AI news',
                    'Draft an email to my team',
                    'How to upload documents?'
                ]);
                resetImageUpload();
                saveState();
            }
        });

        // Start a new chat
        newChat.addEventListener('click', () => {
            if (conversationHistory.length > 0 && confirm('Start a new conversation? Your current chat history will be cleared.')) {
                conversationHistory = [];
                chatContainer.innerHTML = '';
                addMessage('Hello! How can I help you today? Try asking me to search for something using the /search command, or draft an email with /email.', 'assistant-message', false, 
                [
                    'Search the web for AI news',
                    'Draft an email to my team',
                    'How to upload documents?'
                ]);
                resetImageUpload();
                resetDocumentUpload();
                saveState();
            } else if (conversationHistory.length === 0) {
                chatContainer.innerHTML = '';
                addMessage('Hello! How can I help you today? Try asking me to search for something using the /search command, or draft an email with /email.', 'assistant-message', false, 
                [
                    'Search the web for AI news',
                    'Draft an email to my team',
                    'How to upload documents?'
                ]);
            }
        });

        // Response style handlers
        responseStyleOptions.forEach(option => {
            option.addEventListener('change', function() {
                if (this.checked) {
                    currentResponseStyle = this.value;
                    console.log('Response style changed to:', currentResponseStyle);
                    saveState();
                }
            });
        });

        // Feature toggle handlers
        enableSuggestions.addEventListener('change', saveState);
        enableWebSearch.addEventListener('change', saveState);
        enableVoiceInput.addEventListener('change', saveState);

        // Voice input handler (Web Speech API)
        voiceInputBtn.addEventListener('click', toggleVoiceInput);

        function toggleVoiceInput() {
            if (!enableVoiceInput.checked) {
                addMessage("Voice input is disabled. Please enable it in settings.", 'assistant-message');
                return;
            }
            
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                addMessage("Your browser doesn't support speech recognition. Please try a modern browser like Chrome.", 'assistant-message');
                return;
            }
            
            if (isRecording) {
                // Stop recording
                stopVoiceRecording();
            } else {
                // Start recording
                startVoiceRecording();
            }
        }

        function startVoiceRecording() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            
            recognition.lang = 'en-US';
            recognition.continuous = false;
            recognition.interimResults = false;
            
            recognition.onstart = function() {
                isRecording = true;
                voiceInputBtn.classList.add('active');
                
                // Add voice indicator to input
                const voiceIndicator = document.createElement('div');
                voiceIndicator.id = 'voiceIndicator';
                voiceIndicator.classList.add('voice-indicator');
                
                const indicatorDot = document.createElement('div');
                indicatorDot.classList.add('voice-indicator-dot');
                
                const indicatorText = document.createElement('span');
                indicatorText.textContent = 'Listening...';
                
                voiceIndicator.appendChild(indicatorDot);
                voiceIndicator.appendChild(indicatorText);
                
                document.querySelector('.message-input-wrapper').appendChild(voiceIndicator);
            };
            
            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                messageInput.value = transcript;
                messageInput.dispatchEvent(new Event('input')); // Trigger resize/validation
            };
            
            recognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
                stopVoiceRecording();
            };
            
            recognition.onend = function() {
                stopVoiceRecording();
            };
            
            recognition.start();
        }

        function stopVoiceRecording() {
            isRecording = false;
            voiceInputBtn.classList.remove('active');
            
            // Remove voice indicator
            const voiceIndicator = document.getElementById('voiceIndicator');
            if (voiceIndicator) {
                voiceIndicator.remove();
            }
        }

        // Handle suggestion clicks
        chatContainer.addEventListener('click', event => {
            if (event.target.classList.contains('suggestion-item')) {
                const suggestion = event.target.dataset.suggestion;
                messageInput.value = suggestion;
                messageInput.dispatchEvent(new Event('input')); // Trigger resize/validation
                messageInput.focus();
            }
        });

        // --- API Communication ---
        async function sendMessageToLLM(data) {
            try {
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    console.error('API Error Response:', errorBody);
                    throw new Error(`API request failed with status ${response.status}: ${errorBody || response.statusText}`);
                }

                // Handle streaming response
                let fullResponse = '';
                console.log('API Response:', response);
                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    
                    const text = decoder.decode(value);
                    const lines = text.split('\n');
                    console.log('Chunk:', text);
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                if (data.error) {
                                    throw new Error(data.error);
                                }
                                if (data.response) {
                                    fullResponse += data.response;
                                }
                                console.log('Full Response:', fullResponse);
                                if (data.done) {
                                    return fullResponse;
                                }
                            } catch (e) {
                                console.error('Error parsing SSE data:', e);
                            }
                        }
                    }
                }

                return fullResponse;
            } catch (error) {
                console.error('API Communication Error:', error);
                throw error;
            }
        }

        // --- Global Event Listeners ---
        // Close settings panel if clicking outside
        document.addEventListener('click', function(event) {
            if (!settingsPanel.contains(event.target) && !settingsBtn.contains(event.target) && settingsPanel.classList.contains('active')) {
                settingsPanel.classList.remove('active');
            }
        });

        // Initialize chat on load
        document.addEventListener('DOMContentLoaded', initializeChat);
    </script>
</body>
</html>
